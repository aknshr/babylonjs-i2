"use strict";(self.webpackChunk_dev_inspector_v2=self.webpackChunk_dev_inspector_v2||[]).push([[5079],{29107:(e,t,n)=>{n.d(t,{_WebAudioStreamingSound:()=>m});var s=n(83031),i=n(21148),o=n(34493);class a extends o.G{constructor(e,t,n){super(e,t,n),this._preloadedInstances=new Array}get preloadCount(){return this._options.preloadCount??1}get preloadCompletedCount(){return this._preloadedInstances.length}preloadInstanceAsync(){const e=this._createInstance();return this._addPreloadedInstance(e),e.preloadedPromise}async preloadInstancesAsync(e){for(let t=0;t<e;t++)this.preloadInstanceAsync();await Promise.all(this._preloadedInstances.map((async e=>await e.preloadedPromise)))}play(e={}){if(5===this.state)return void this.resume();let t;this.preloadCompletedCount>0?(t=this._preloadedInstances[0],t.startOffset=this.startOffset,this._removePreloadedInstance(t)):t=this._createInstance();const n=()=>{3===t.state&&(this._stopExcessInstances(),t.onStateChangedObservable.removeCallback(n))};t.onStateChangedObservable.add(n),e.startOffset??=this.startOffset,e.loop??=this.loop,e.volume??=1,this._beforePlay(t),t.play(e),this._afterPlay(t)}stop(){if(this._setState(1),this._instances)for(const e of Array.from(this._instances))e.stop()}_addPreloadedInstance(e){this._preloadedInstances.includes(e)||this._preloadedInstances.push(e)}_removePreloadedInstance(e){const t=this._preloadedInstances.indexOf(e);-1!==t&&this._preloadedInstances.splice(t,1)}}var r=n(2902),d=n(40742);class u extends d.g{constructor(e){super(e),this.onReadyObservable=new r.cP,this.preloadedPromise=new Promise(((e,t)=>{this._rejectPreloadedProimse=t,this._resolvePreloadedPromise=e})),this.onErrorObservable.add(this._rejectPreloadedProimse),this.onReadyObservable.add(this._resolvePreloadedPromise)}set startOffset(e){this._options.startOffset=e}dispose(){super.dispose(),this.onErrorObservable.clear(),this.onReadyObservable.clear(),this._resolvePreloadedPromise()}}var l=n(29418),h=n(49542),c=n(99532),_=n(4008),p=n(21336);class m extends a{constructor(e,t,n){super(e,t,n),this._stereo=null,this._options={autoplay:n.autoplay??!1,loop:n.loop??!1,maxInstances:n.maxInstances??1/0,preloadCount:n.preloadCount??1,startOffset:n.startOffset??0},this._subGraph=new m._SubGraph(this)}async _initAsync(e,t){const n=this.engine._audioContext;if(!(n instanceof AudioContext))throw new Error("Unsupported audio context type.");this._audioContext=n,this._source=e,t.outBus?this.outBus=t.outBus:!1!==t.outBusAutoDefault&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(t),(0,l.GB)(t)&&this._initSpatialProperty(),this.preloadCount&&await this.preloadInstancesAsync(this.preloadCount),t.autoplay&&this.play(t),this.engine._addSound(this)}get _inNode(){return this._subGraph._inNode}get _outNode(){return this._subGraph._outNode}get stereo(){return this._stereo??(this._stereo=new h.i(this._subGraph))}dispose(){super.dispose(),this._stereo=null,this._subGraph.dispose(),this.engine._removeSound(this)}getClassName(){return"_WebAudioStreamingSound"}_createInstance(){return new f(this,this._options)}_connect(e){return!!super._connect(e)&&(e._inNode&&this._outNode?.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e._inNode&&this._outNode?.disconnect(e._inNode),!0)}_createSpatialProperty(e,t){return new p.i(this._subGraph,e,t)}_getOptions(){return this._options}}m._SubGraph=class extends _.Q{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}};class f extends u{constructor(e,t){if(super(e),this._currentTimeChangedWhilePaused=!1,this._enginePlayTime=1/0,this._enginePauseTime=0,this._isReady=!1,this._isReadyPromise=new Promise(((e,t)=>{this._resolveIsReadyPromise=e,this._rejectIsReadyPromise=t})),this._onCanPlayThrough=()=>{this._isReady=!0,this._resolveIsReadyPromise(this._mediaElement),this.onReadyObservable.notifyObservers(this)},this._onEnded=()=>{this.onEndedObservable.notifyObservers(this),this.dispose()},this._onError=e=>{this._setState(4),this.onErrorObservable.notifyObservers(e),this._rejectIsReadyPromise(e),this.dispose()},this._onEngineStateChanged=()=>{"running"===this.engine.state&&(this._options.loop&&2===this.state&&this.play(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged))},this._onUserGesture=()=>{this.play()},this._options=t,this._volumeNode=new GainNode(e._audioContext),"string"==typeof e._source)this._initFromUrl(e._source);else if(Array.isArray(e._source))this._initFromUrls(e._source);else{if(!(e._source instanceof HTMLMediaElement))throw new Error(`Invalid streaming sound source (${e._source}).`);this._initFromMediaElement(e._source)}}get currentTime(){if(1===this._state)return 0;const e=5===this._state?0:this.engine.currentTime-this._enginePlayTime;return this._enginePauseTime+e+this._options.startOffset}set currentTime(e){const t=2===this._state||3===this._state;t&&(this._mediaElement.pause(),this._state=1),this._options.startOffset=e,t?this.play({startOffset:e}):5===this._state&&(this._currentTimeChangedWhilePaused=!0)}get _outNode(){return this._volumeNode}get startTime(){return 1===this._state?0:this._enginePlayTime}dispose(){super.dispose(),this.stop(),this._sourceNode?.disconnect(this._volumeNode),this._sourceNode=null,this._mediaElement.removeEventListener("error",this._onError),this._mediaElement.removeEventListener("ended",this._onEnded),this._mediaElement.removeEventListener("canplaythrough",this._onCanPlayThrough);for(const e of Array.from(this._mediaElement.children))this._mediaElement.removeChild(e);this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged),this.engine.userGestureObservable.removeCallback(this._onUserGesture)}play(e={}){if(3===this._state)return;void 0!==e.loop&&(this._options.loop=e.loop),this._mediaElement.loop=this._options.loop;let t=e.startOffset;this._currentTimeChangedWhilePaused?(t=this._options.startOffset,this._currentTimeChangedWhilePaused=!1):5===this._state&&(t=this.currentTime+this._options.startOffset),t&&t>0&&(this._mediaElement.currentTime=t),this._volumeNode.gain.value=e.volume??1,this._play()}pause(){2!==this._state&&3!==this._state||(this._setState(5),this._enginePauseTime+=this.engine.currentTime-this._enginePlayTime,this._mediaElement.pause())}resume(){(5===this._state||this._currentTimeChangedWhilePaused)&&this.play()}stop(){1!==this._state&&this._stop()}getClassName(){return"_WebAudioStreamingSoundInstance"}_connect(e){return!!super._connect(e)&&(e instanceof m&&e._inNode&&this._outNode?.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e instanceof m&&e._inNode&&this._outNode?.disconnect(e._inNode),!0)}_initFromMediaElement(e){if(i.S0.SetCorsBehavior(e.currentSrc,e),e.controls=!1,e.loop=this._options.loop,e.preload="auto",e.addEventListener("canplaythrough",this._onCanPlayThrough,{once:!0}),e.addEventListener("ended",this._onEnded,{once:!0}),e.addEventListener("error",this._onError,{once:!0}),e.load(),this._sourceNode=new MediaElementAudioSourceNode(this._sound._audioContext,{mediaElement:e}),this._sourceNode.connect(this._volumeNode),!this._connect(this._sound))throw new Error("Connect failed");this._mediaElement=e}_initFromUrl(e){const t=new Audio((0,c.Ki)(e));this._initFromMediaElement(t)}_initFromUrls(e){const t=new Audio;for(const n of e){const e=document.createElement("source");e.src=(0,c.Ki)(n),t.appendChild(e)}this._initFromMediaElement(t)}_play(){if(this._setState(2),this._isReady){if(2===this._state)if("running"===this.engine.state){const e=this._mediaElement.play();this._enginePlayTime=this.engine.currentTime,this._setState(3),e.catch((()=>{this._setState(4),this._options.loop&&this.engine.userGestureObservable.addOnce(this._onUserGesture)}))}else this._options.loop?this.engine.stateChangedObservable.add(this._onEngineStateChanged):(this.stop(),this._setState(4))}else this._playWhenReady()}_playWhenReady(){this._isReadyPromise.then((()=>{this._play()})).catch((()=>{s.V.Error("Streaming sound instance failed to play"),this._setState(4)}))}_stop(){this._mediaElement.pause(),this._setState(1),this._onEnded(),this.engine.stateChangedObservable.removeCallback(this._onEngineStateChanged)}}},35079:(e,t,n)=>{n.d(t,{MSFT_audio_emitter:()=>M});var s=n(31273),i=n(21148);class o{constructor(e,t,n){this.frame=e,this.action=t,this.onlyOnce=n,this.isDone=!1}_clone(){return new o(this.frame,this.action,this.onlyOnce)}}var a=n(29418),r=n(98826),d=n(91127),u=n(29107),l=n(67416),h=n(23473),c=n(43405),_=n(83031),p=n(2902),m=n(62194),f=n(72062);const g={duration:0,shape:"linear"},A={duration:0,startOffset:0,waitTime:0},y={waitTime:0};function b(e){return e*Math.PI/180}function C(e){return 180*e/Math.PI}class T{get name(){return this._soundV2.name}set name(e){this._soundV2.name=e}get autoplay(){return this._soundV2 instanceof r._WebAudioSoundSource||this._optionsV2.autoplay}set autoplay(e){this._optionsV2.autoplay=e}get loop(){return this._soundV2 instanceof r._WebAudioSoundSource||this._soundV2.loop}set loop(e){this._soundV2 instanceof r._WebAudioSoundSource||this._soundV2&&(this._soundV2.loop=e)}get isPlaying(){return this._soundV2 instanceof r._WebAudioSoundSource||3===this._soundV2?.state||!this.isReady()&&this._optionsV2.autoplay}get isPaused(){return!(this._soundV2 instanceof r._WebAudioSoundSource)&&5===this._soundV2.state}get maxDistance(){return this._optionsV2.spatialMaxDistance||100}set maxDistance(e){this._optionsV2.spatialMaxDistance=e,this.useCustomAttenuation||this._soundV2&&(this._initSpatial(),this._soundV2.spatial.maxDistance=e)}get distanceModel(){return this._optionsV2.spatialDistanceModel||"linear"}set distanceModel(e){this._optionsV2.spatialDistanceModel=e,this._soundV2&&(this._initSpatial(),this._soundV2.spatial.distanceModel=e)}get currentTime(){return this._soundV2 instanceof r._WebAudioSoundSource?this._soundV2.engine.currentTime:this._soundV2.currentTime}get spatialSound(){return this._soundV2?._isSpatial??!1}set spatialSound(e){this._soundV2&&(e?this._initSpatial():this._soundV2._isSpatial=!1)}get _onReady(){return this._onReadyObservable||(this._onReadyObservable=new p.cP),this._onReadyObservable}constructor(e,t,n,i=null,o){if(this.useCustomAttenuation=!1,this.soundTrackId=-1,this.refDistance=1,this.rolloffFactor=1,this.metadata=null,this.onEndedObservable=new p.cP,this._localDirection=new s.Pq(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._isOutputConnected=!1,this._url=null,this._onReadyObservable=null,this._onReadyToPlay=()=>{this._scene.mainSoundTrack.addSound(this),this._isReadyToPlay=!0,this._readyToPlayCallback(),this._onReadyObservable&&this._onReadyObservable.notifyObservers(),this._optionsV2.autoplay&&this.play()},this._onended=()=>{this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)},!(n=n||h.q.LastCreatedScene))return;this._scene=n,T._SceneComponentInitialization(n),this._readyToPlayCallback=i||(()=>{}),this._customAttenuationFunction=(e,t,n,s,i)=>t<n?e*(1-t/n):0;const c={analyzerEnabled:!1,autoplay:!1,duration:(o=o||{}).length||0,loop:o.loop||!1,loopEnd:0,loopStart:0,outBus:null,outBusAutoDefault:!1,playbackRate:o.playbackRate||1,pitch:0,skipCodecCheck:o.skipCodecCheck||!1,spatialDistanceModel:o.distanceModel,spatialEnabled:o.spatialSound,spatialMaxDistance:o.maxDistance,spatialMinDistance:o.refDistance,spatialRolloffFactor:o.rolloffFactor,stereoEnabled:!1,startOffset:o.offset||0,volume:o.volume??1};this._volume=o.volume??1,(0,a.GB)(c)&&(c.spatialAutoUpdate=!1,c.spatialConeInnerAngle=a.Qc.coneInnerAngle,c.spatialConeOuterAngle=a.Qc.coneOuterAngle,c.spatialConeOuterVolume=a.Qc.coneOuterVolume,c.spatialMinUpdateTime=0,c.spatialOrientation=a.Qc.orientation.clone(),c.spatialPanningModel=this._scene.headphone?"HRTF":"equalpower",c.spatialPosition=a.Qc.position.clone(),c.spatialRotation=a.Qc.rotation.clone(),c.spatialRotationQuaternion=a.Qc.rotationQuaternion.clone(),void 0===c.spatialMaxDistance&&(c.spatialMaxDistance=100)),this._optionsV2={...c},this._optionsV2.autoplay=o.autoplay||!1,this.useCustomAttenuation=o.useCustomAttenuation??!1,this.useCustomAttenuation&&(c.spatialMaxDistance=Number.MAX_VALUE,c.volume=0);let m=o?.streaming||!1;if(!l.$.audioEngine)return;const f=l.$.audioEngine._v2,g=()=>{if(m){const n={preloadCount:0,...c},s=new u._WebAudioStreamingSound(e,f,n);return s._initAsync(t,c).then((()=>{s.preloadInstancesAsync(1).then(this._onReadyToPlay)})),s}{const n=new d._WebAudioStaticSound(e,f,c);return n._initAsync(t,c).then(this._onReadyToPlay),n}};if(t)if("string"==typeof t)this._url=t,this._soundV2=g();else if(t instanceof ArrayBuffer)m=!1,this._soundV2=g();else if(t instanceof HTMLMediaElement)m=!0,this._soundV2=g();else if(t instanceof MediaStream){const n=new MediaStreamAudioSourceNode(f._audioContext,{mediaStream:t});this._soundV2=new r._WebAudioSoundSource(e,n,f,c),this._soundV2._initAsync(c).then(this._onReadyToPlay)}else t instanceof AudioBuffer?(m=!1,this._soundV2=g()):Array.isArray(t)&&(this._soundV2=g());else this._soundV2=new d._WebAudioStaticSound(e,f,c);this._soundV2?this._soundV2 instanceof r._WebAudioSoundSource||this._soundV2.onEndedObservable.add(this._onended):_.V.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}dispose(){this.isPlaying&&this.stop(),this._isReadyToPlay=!1,-1===this.soundTrackId?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null),this._soundV2.dispose()}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}setAudioBuffer(e){this._isReadyToPlay||this._soundV2 instanceof d._WebAudioStaticSound&&this._soundV2._initAsync(e,this._optionsV2).then(this._onReadyToPlay)}updateOptions(e){if(e){if(this.loop=e.loop??this.loop,this.maxDistance=e.maxDistance??this.maxDistance,this.useCustomAttenuation=e.useCustomAttenuation??this.useCustomAttenuation,this.rolloffFactor=e.rolloffFactor??this.rolloffFactor,this.refDistance=e.refDistance??this.refDistance,this.distanceModel=e.distanceModel??this.distanceModel,void 0!==e.playbackRate&&this.setPlaybackRate(e.playbackRate),void 0!==e.spatialSound&&(this.spatialSound=e.spatialSound),void 0!==e.volume&&this.setVolume(e.volume),this._soundV2 instanceof d._WebAudioStaticSound){let t=!1;void 0!==e.offset&&(this._optionsV2.startOffset=e.offset,t=!0),void 0!==e.length&&(this._soundV2.duration=e.length,t=!0),t&&this.isPaused&&this.stop()}this._updateSpatialParameters()}}_updateSpatialParameters(){if(!this.spatialSound)return;const e=this._soundV2.spatial;this.useCustomAttenuation?(e.distanceModel="linear",e.minDistance=1,e.maxDistance=Number.MAX_VALUE,e.rolloffFactor=1,e.panningModel="equalpower"):(e.distanceModel=this.distanceModel,e.minDistance=this.refDistance,e.maxDistance=this.maxDistance,e.rolloffFactor=this.rolloffFactor,e.panningModel=this._optionsV2.spatialPanningModel||"equalpower")}switchPanningModelToHRTF(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="HRTF")}switchPanningModelToEqualPower(){this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.panningModel="equalpower")}connectToSoundTrackAudioNode(e){const t=this._soundV2._outNode;t&&(this._isOutputConnected&&t.disconnect(),t.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,n){t<e?_.V.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle."):(this._optionsV2.spatialConeInnerAngle=b(e),this._optionsV2.spatialConeOuterAngle=b(t),this._optionsV2.spatialConeOuterVolume=n,this._initSpatial(),this._soundV2.spatial.coneInnerAngle=this._optionsV2.spatialConeInnerAngle,this._soundV2.spatial.coneOuterAngle=this._optionsV2.spatialConeOuterAngle,this._soundV2.spatial.coneOuterVolume=n,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration)))}get directionalConeInnerAngle(){return C("number"==typeof this._optionsV2.spatialConeInnerAngle?this._optionsV2.spatialConeInnerAngle:a.Qc.coneInnerAngle)}set directionalConeInnerAngle(e){if((e=b(e))!=this._optionsV2.spatialConeInnerAngle){if(this.directionalConeOuterAngle<e)return void _.V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._optionsV2.spatialConeInnerAngle=e,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneInnerAngle=e)}}get directionalConeOuterAngle(){return C("number"==typeof this._optionsV2.spatialConeOuterAngle?this._optionsV2.spatialConeOuterAngle:a.Qc.coneOuterAngle)}set directionalConeOuterAngle(e){if((e=b(e))!=this._optionsV2.spatialConeOuterAngle){if(e<this.directionalConeInnerAngle)return void _.V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._optionsV2.spatialConeOuterAngle=e,this.spatialSound&&(this._initSpatial(),this._soundV2.spatial.coneOuterAngle=e)}}setPosition(e){this._optionsV2.spatialPosition&&e.equals(this._optionsV2.spatialPosition)||(this._optionsV2.spatialPosition||(this._optionsV2.spatialPosition=s.Pq.Zero()),this._optionsV2.spatialPosition.copyFrom(e),!this.spatialSound||isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||(this._initSpatial(),this._soundV2.spatial.position=e))}setLocalDirectionToMesh(e){this._localDirection=e,this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this.spatialSound)return;const e=this._connectedTransformNode.getWorldMatrix(),t=s.Pq.TransformNormal(this._localDirection,e);t.normalize(),this._initSpatial(),this._soundV2.spatial.orientation=t}_initSpatial(){this._soundV2._isSpatial=!0,void 0===this._optionsV2.spatialDistanceModel&&(this._optionsV2.spatialDistanceModel="linear",this._soundV2.spatial.distanceModel="linear"),void 0===this._optionsV2.spatialMaxDistance&&(this._optionsV2.spatialMaxDistance=100,this._soundV2.spatial.maxDistance=100)}updateDistanceFromListener(){if(this._soundV2._outNode&&this._connectedTransformNode&&this.useCustomAttenuation&&this._scene.activeCamera){const e=this._scene.audioListenerPositionProvider?this._connectedTransformNode.position.subtract(this._scene.audioListenerPositionProvider()).length():this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundV2.volume=this._customAttenuationFunction(this._volume,e,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,n){const s=l.$.audioEngine;if(s?.unlock(),!(this._soundV2 instanceof r._WebAudioSoundSource)&&this._isReadyToPlay&&this._scene.audioEnabled){5!==this._soundV2.state||void 0===e&&void 0===t&&void 0===n||this._soundV2.stop();try{A.duration=n||0,A.startOffset=void 0!==t&&t||this._optionsV2.startOffset,A.waitTime=e||0,s?.unlocked?this._soundV2.play(A):setTimeout((()=>{this._soundV2.play(A)}),500)}catch(e){_.V.Error("Error while trying to play audio: "+this.name+", "+e.message)}}}stop(e){this._soundV2&&(this._soundV2 instanceof r._WebAudioSoundSource||(y.waitTime=e||0,this._soundV2.stop(y)))}pause(){this._soundV2&&(this._soundV2 instanceof r._WebAudioSoundSource||this._soundV2.pause())}setVolume(e,t){this.isReady()?(g.duration=t||0,this._soundV2.setVolume(e,g),this._volume=e):this._onReady.addOnce((()=>{this.setVolume(e,t)}))}setPlaybackRate(e){this._soundV2 instanceof d._WebAudioStaticSound&&(this._soundV2.playbackRate=e)}getPlaybackRate(){return this._soundV2 instanceof d._WebAudioStaticSound?this._soundV2.playbackRate:1}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this.spatialSound||(this.spatialSound=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._optionsV2.startOffset,this._optionsV2.duration))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=e=>this._onRegisterAfterWorldMatrixUpdate(e),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){if(e.getBoundingInfo){const t=e.getBoundingInfo();this.setPosition(t.boundingSphere.centerWorld)}else this.setPosition(e.absolutePosition);this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(!(this._soundV2 instanceof d._WebAudioStaticSound))return null;const e={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},t=new T(this.name+"_cloned",this._soundV2.buffer,this._scene,null,e);return t._optionsV2=this._optionsV2,this.useCustomAttenuation&&t.setAttenuationFunction(this._customAttenuationFunction),t}getAudioBuffer(){return this._soundV2 instanceof d._WebAudioStaticSound?this._soundV2.buffer._audioBuffer:null}getSoundSource(){return null}getSoundGain(){return this._soundV2._outNode}serialize(){const e={name:this.name,url:this._url,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this.spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this.getPlaybackRate(),panningModel:this._soundV2.spatial.panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this.spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._soundV2.spatial.position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this.directionalConeInnerAngle,e.coneOuterAngle=this.directionalConeOuterAngle,e.coneOuterGain=this._soundV2.spatial.coneOuterVolume),e}static Parse(e,t,n,i){const o=e.name;let a;a=e.url?n+e.url:n+o;const r={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let d;if(i){const e=()=>{(0,m.B)((()=>i._isReadyToPlay),(()=>{const e=i.getAudioBuffer();e&&d.setAudioBuffer(e),d._isReadyToPlay=!0,d.autoplay&&d.play(0,i._optionsV2.startOffset,i._optionsV2.duration)}),void 0,300)};d=new T(o,new ArrayBuffer(0),t,null,r),e()}else d=new T(o,a,t,(()=>{t.removePendingData(d)}),r),t.addPendingData(d);if(e.position){const t=s.Pq.FromArray(e.position);d.setPosition(t)}if(e.isDirectional&&(d.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const t=s.Pq.FromArray(e.localDirectionToMesh);d.setLocalDirectionToMesh(t)}if(e.connectedMeshId){const n=t.getMeshById(e.connectedMeshId);n&&d.attachToMesh(n)}return e.metadata&&(d.metadata=e.metadata),d}}T._SceneComponentInitialization=e=>{throw(0,c.n)("AudioSceneComponent")},(0,f.Y5)("BABYLON.Sound",T);class v{constructor(e,t,n){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==n.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=n;let s=0;for(const e of n)s+=e;const i=s>0?1/s:0;for(let e=0;e<this._weights.length;e++)this._weights[e]*=i;this._sounds=t;for(const e of this._sounds)e.onEndedObservable.add((()=>{this._onended()}))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e)return void _.V.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle)return void _.V.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){void 0!==this._currentIndex&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPlaying&&(this.isPaused=!0,void 0!==this._currentIndex&&this._sounds[this._currentIndex].pause())}stop(){this.isPlaying=!1,void 0!==this._currentIndex&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const e=Math.random();let t=0;for(let n=0;n<this._weights.length;n++)if(t+=this._weights[n],e<=t){this._currentIndex=n;break}}const t=this._sounds[this._currentIndex??0];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}var S=n(69884),P=n(96734);class V{constructor(e,t={}){this.id=-1,this._isInitialized=!1,(e=e||h.q.LastCreatedScene)&&(this._scene=e,this.soundCollection=[],this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){l.$.audioEngine?.canUseWebAudio&&l.$.audioEngine.audioContext&&(this._outputAudioNode=l.$.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(l.$.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(l.$.audioEngine&&l.$.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){this._isInitialized||this._initializeSoundTrackAudioGraph(),l.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),void 0!==e.soundTrackId&&(-1===e.soundTrackId?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);-1!==t&&this.soundCollection.splice(t,1)}setVolume(e){l.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){if(l.$.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){if(l.$.audioEngine?.canUseWebAudio)for(let e=0;e<this.soundCollection.length;e++)this.soundCollection[e].switchPanningModelToEqualPower()}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,l.$.audioEngine?.canUseWebAudio&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,l.$.audioEngine.masterGain))}}var w=n(95271),E=n(60743),N=(n(53190),n(89731));(0,n(85706).ji)(w.v.NAME_AUDIO,((e,t,n,s)=>{let i,o=[];if(n.sounds=n.sounds||[],void 0!==e.sounds&&null!==e.sounds)for(let a=0,r=e.sounds.length;a<r;a++){const r=e.sounds[a];l.$.audioEngine?.canUseWebAudio?(r.url||(r.url=r.name),o[r.url]?n.sounds.push(T.Parse(r,t,s,o[r.url])):(i=T.Parse(r,t,s),o[r.url]=i,n.sounds.push(i))):n.sounds.push(new T(r.name,null,t))}o=[]})),Object.defineProperty(E.Z.prototype,"mainSoundTrack",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),this._mainSoundTrack||(this._mainSoundTrack=new V(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0}),E.Z.prototype.getSoundByName=function(e){let t;for(t=0;t<this.mainSoundTrack.soundCollection.length;t++)if(this.mainSoundTrack.soundCollection[t].name===e)return this.mainSoundTrack.soundCollection[t];if(this.soundTracks)for(let n=0;n<this.soundTracks.length;n++)for(t=0;t<this.soundTracks[n].soundCollection.length;t++)if(this.soundTracks[n].soundCollection[t].name===e)return this.soundTracks[n].soundCollection[t];return null},Object.defineProperty(E.Z.prototype,"audioEnabled",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),e.audioEnabled},set:function(e){let t=this._getComponent(w.v.NAME_AUDIO);t||(t=new D(this),this._addComponent(t)),e?t.enableAudio():t.disableAudio()},enumerable:!0,configurable:!0}),Object.defineProperty(E.Z.prototype,"headphone",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),e.headphone},set:function(e){let t=this._getComponent(w.v.NAME_AUDIO);t||(t=new D(this),this._addComponent(t)),e?t.switchAudioModeForHeadphones():t.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0}),Object.defineProperty(E.Z.prototype,"audioListenerPositionProvider",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),e.audioListenerPositionProvider},set:function(e){let t=this._getComponent(w.v.NAME_AUDIO);if(t||(t=new D(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");t.audioListenerPositionProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(E.Z.prototype,"audioListenerRotationProvider",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),e.audioListenerRotationProvider},set:function(e){let t=this._getComponent(w.v.NAME_AUDIO);if(t||(t=new D(this),this._addComponent(t)),e&&"function"!=typeof e)throw new Error("The value passed to [Scene.audioListenerRotationProvider] must be a function that returns a Vector3");t.audioListenerRotationProvider=e},enumerable:!0,configurable:!0}),Object.defineProperty(E.Z.prototype,"audioPositioningRefreshRate",{get:function(){let e=this._getComponent(w.v.NAME_AUDIO);return e||(e=new D(this),this._addComponent(e)),e.audioPositioningRefreshRate},set:function(e){let t=this._getComponent(w.v.NAME_AUDIO);t||(t=new D(this),this._addComponent(t)),t.audioPositioningRefreshRate=e},enumerable:!0,configurable:!0});class D{get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}constructor(e){this.name=w.v.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this.audioListenerPositionProvider=null,this.audioListenerRotationProvider=null,this._cachedCameraDirection=new s.Pq,this._cachedCameraPosition=new s.Pq,this._lastCheck=0,this._invertMatrixTemp=new s.uq,this._cameraDirectionTemp=new s.Pq,(e=e||h.q.LastCreatedScene)&&(this.scene=e,e.soundTracks=[],e.sounds=[])}register(){this.scene._afterRenderStage.registerStep(w.v.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const n=this.scene.soundTracks[t];for(let t=0;t<n.soundCollection.length;t++)e.sounds.push(n.soundCollection[t].serialize())}}addFromContainer(e){if(e.sounds)for(const t of e.sounds)t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)}removeFromContainer(e,t=!1){if(e.sounds)for(const n of e.sounds)n.stop(),n.autoplay=!1,this.scene.mainSoundTrack.removeSound(n),t&&n.dispose()}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;let t;for(this._audioEnabled=!1,l.$.audioEngine&&l.$.audioEngine.audioContext&&l.$.audioEngine.audioContext.suspend(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].pause()}enableAudio(){const e=this.scene;let t;for(this._audioEnabled=!0,l.$.audioEngine&&l.$.audioEngine.audioContext&&l.$.audioEngine.audioContext.resume(),t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let n=0;n<e.soundTracks[t].soundCollection.length;n++)e.soundTracks[t].soundCollection[n].isPaused&&e.soundTracks[t].soundCollection[n].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=N.j.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||0===t._mainSoundTrack.soundCollection.length&&1===t.soundTracks.length)return;const n=l.$.audioEngine;if(n&&n.audioContext){let e,i=t.activeCamera;if(t.activeCameras&&t.activeCameras.length>0&&(i=t.activeCameras[0]),this.audioListenerPositionProvider){const e=this.audioListenerPositionProvider();n.audioContext.listener.setPosition(e.x||0,e.y||0,e.z||0)}else i?this._cachedCameraPosition.equals(i.globalPosition)||(this._cachedCameraPosition.copyFrom(i.globalPosition),n.audioContext.listener.setPosition(i.globalPosition.x,i.globalPosition.y,i.globalPosition.z)):n.audioContext.listener.setPosition(0,0,0);if(this.audioListenerRotationProvider){const e=this.audioListenerRotationProvider();n.audioContext.listener.setOrientation(e.x||0,e.y||0,e.z||0,0,1,0)}else i?(i.rigCameras&&i.rigCameras.length>0&&(i=i.rigCameras[0]),i.getViewMatrix().invertToRef(this._invertMatrixTemp),s.Pq.TransformNormalToRef(D._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),isNaN(this._cameraDirectionTemp.x)||isNaN(this._cameraDirectionTemp.y)||isNaN(this._cameraDirectionTemp.z)||this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),n.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0))):n.audioContext.listener.setOrientation(0,0,0,0,1,0);for(e=0;e<t.mainSoundTrack.soundCollection.length;e++){const n=t.mainSoundTrack.soundCollection[e];n.useCustomAttenuation&&n.updateDistanceFromListener()}if(t.soundTracks)for(e=0;e<t.soundTracks.length;e++)for(let n=0;n<t.soundTracks[e].soundCollection.length;n++){const s=t.soundTracks[e].soundCollection[n];s.useCustomAttenuation&&s.updateDistanceFromListener()}}}}D._CameraDirection=new s.Pq(0,0,-1),T._SceneComponentInitialization=e=>{let t=e._getComponent(w.v.NAME_AUDIO);t||(t=new D(e),e._addComponent(t))};const O="MSFT_audio_emitter";class M{constructor(e){this.name=O,this._loader=e,this.enabled=this._loader.isExtensionUsed(O)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,S.l2.Assign(this._clips),S.l2.Assign(this._emitters)}}loadSceneAsync(e,t){return S.BT.LoadExtensionAsync(e,t,this.name,(async(n,s)=>{const i=new Array;i.push(this._loader.loadSceneAsync(e,t));for(const e of s.emitters){const t=S.l2.Get(`${n}/emitters`,this._emitters,e);if(null!=t.refDistance||null!=t.maxDistance||null!=t.rolloffFactor||null!=t.distanceModel||null!=t.innerAngle||null!=t.outerAngle)throw new Error(`${n}: Direction or Distance properties are not allowed on emitters attached to a scene`);i.push(this._loadEmitterAsync(`${n}/emitters/${t.index}`,t))}await Promise.all(i)}))}loadNodeAsync(e,t,n){return S.BT.LoadExtensionAsync(e,t,this.name,(async(e,o)=>{const a=new Array,r=await this._loader.loadNodeAsync(e,t,(t=>{for(const n of o.emitters){const o=S.l2.Get(`${e}/emitters`,this._emitters,n);a.push(this._loadEmitterAsync(`${e}/emitters/${o.index}`,o).then((()=>{for(const e of o._babylonSounds)e.attachToMesh(t),null==o.innerAngle&&null==o.outerAngle||(e.setLocalDirectionToMesh(s.Pq.Forward()),e.setDirectionalCone(2*i.S0.ToDegrees(null==o.innerAngle?Math.PI:o.innerAngle),2*i.S0.ToDegrees(null==o.outerAngle?Math.PI:o.outerAngle),0))})))}n(t)}));return await Promise.all(a),r}))}loadAnimationAsync(e,t){return S.BT.LoadExtensionAsync(e,t,this.name,(async(n,s)=>{const i=await this._loader.loadAnimationAsync(e,t),o=new Array;S.l2.Assign(s.events);for(const a of s.events)o.push(this._loadAnimationEventAsync(`${n}/events/${a.index}`,e,t,a,i));return await Promise.all(o),i}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let n;if(t.uri)n=this._loader.loadUriAsync(e,t,t.uri);else{const s=S.l2.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);n=this._loader.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}return t._objectURL=n.then((e=>URL.createObjectURL(new Blob([e],{type:t.mimeType})))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const e=new Array,n=t.name||`emitter${t.index}`,s={loop:!1,autoplay:!1,volume:null==t.volume?1:t.volume};for(let i=0;i<t.clips.length;i++){const o=`/extensions/${this.name}/clips`,a=S.l2.Get(o,this._clips,t.clips[i].clip);e.push(this._loadClipAsync(`${o}/${t.clips[i].clip}`,a).then((e=>{const o=t._babylonSounds[i]=new T(n,e,this._loader.babylonScene,null,s);o.refDistance=t.refDistance||1,o.maxDistance=t.maxDistance||256,o.rolloffFactor=t.rolloffFactor||1,o.distanceModel=t.distanceModel||"exponential"})))}const o=Promise.all(e).then((()=>{const e=t.clips.map((e=>e.weight||1)),n=new v(t.loop||!1,t._babylonSounds,e);t.innerAngle&&(n.directionalConeInnerAngle=2*i.S0.ToDegrees(t.innerAngle)),t.outerAngle&&(n.directionalConeOuterAngle=2*i.S0.ToDegrees(t.outerAngle)),t.volume&&(n.volume=t.volume),t._babylonData.sound=n}));t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,n,s,i){switch(n){case"play":return e=>{const n=(i||0)+(e-s);t.play(n)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${n}`)}}_loadAnimationEventAsync(e,t,n,s,i){if(0==i.targetedAnimations.length)return Promise.resolve();const a=i.targetedAnimations[0],r=s.emitter,d=S.l2.Get(`/extensions/${this.name}/emitters`,this._emitters,r);return this._loadEmitterAsync(e,d).then((()=>{const t=d._babylonData.sound;if(t){const n=new o(s.time,this._getEventAction(e,t,s.action,s.time,s.startOffset));a.animation.addEvent(n),i.onAnimationGroupEndObservable.add((()=>{t.stop()})),i.onAnimationGroupPauseObservable.add((()=>{t.pause()}))}}))}}(0,P.Hg)(O),(0,P.Ye)(O,!0,(e=>new M(e)))},98826:(e,t,n)=>{n.d(t,{_WebAudioSoundSource:()=>d});var s=n(3212),i=n(29418),o=n(49542),a=n(4008),r=n(21336);class d extends s.L{constructor(e,t,n,s){super(e,n,s),this._stereo=null,this._audioContext=this.engine._audioContext,this._webAudioNode=t,this._subGraph=new d._SubGraph(this)}async _initAsync(e){e.outBus?this.outBus=e.outBus:!1!==e.outBusAutoDefault&&(await this.engine.isReadyPromise,this.outBus=this.engine.defaultMainBus),await this._subGraph.initAsync(e),(0,i.GB)(e)&&this._initSpatialProperty(),this.engine._addNode(this)}get _inNode(){return this._webAudioNode}get _outNode(){return this._subGraph._outNode}get stereo(){return this._stereo??(this._stereo=new o.i(this._subGraph))}dispose(){super.dispose(),this._stereo=null,this._subGraph.dispose(),this.engine._removeNode(this)}getClassName(){return"_WebAudioSoundSource"}_connect(e){return!!super._connect(e)&&(e._inNode&&this._outNode?.connect(e._inNode),!0)}_disconnect(e){return!!super._disconnect(e)&&(e._inNode&&this._outNode?.disconnect(e._inNode),!0)}_createSpatialProperty(e,t){return new r.i(this._subGraph,e,t)}}d._SubGraph=class extends a.Q{get _downstreamNodes(){return this._owner._downstreamNodes??null}get _upstreamNodes(){return this._owner._upstreamNodes??null}_onSubNodesChanged(){super._onSubNodesChanged(),this._owner._inNode.disconnect(),this._owner._subGraph._inNode&&this._owner._inNode.connect(this._owner._subGraph._inNode)}}}}]);
//# sourceMappingURL=5079.bundle.js.map