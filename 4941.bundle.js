"use strict";(self.webpackChunk_dev_inspector_v2=self.webpackChunk_dev_inspector_v2||[]).push([[4941],{44941:(e,t,r)=>{r.r(t),r.d(t,{CaptureServiceDefinition:()=>M,default:()=>k});var i=r(11798),s=r(87542),n=r(72632),a=r(41766),o=r(21148),c=r(20697),h=r(5919);class d{static IsSupported(e,t){const r=t??e.getRenderingCanvas();return!!r&&"function"==typeof r.captureStream}get isRecording(){return!!this._canvas&&this._isRecording}constructor(e,t={}){if(!d.IsSupported(e,t.canvas))throw"Your browser does not support recording so far.";const r=t.canvas??e.getRenderingCanvas();if(!r)throw"The babylon engine must have a canvas to be recorded";this._canvas=r,this._isRecording=!1,this._options={...d._DefaultOptions,...t};const i=this._canvas.captureStream(this._options.fps);if(this._options.audioTracks)for(const e of this._options.audioTracks)i.addTrack(e);this._mediaRecorder=new MediaRecorder(i,{mimeType:this._options.mimeType}),this._mediaRecorder.ondataavailable=e=>this._handleDataAvailable(e),this._mediaRecorder.onerror=e=>this._handleError(e),this._mediaRecorder.onstop=()=>this._handleStop()}stopRecording(){this._canvas&&this._mediaRecorder&&this.isRecording&&(this._isRecording=!1,this._mediaRecorder.stop())}startRecording(e="babylonjs.webm",t=7){if(!this._canvas||!this._mediaRecorder)throw"Recorder has already been disposed";if(this.isRecording)throw"Recording already in progress";return t>0&&setTimeout((()=>{this.stopRecording()}),1e3*t),this._fileName=e,this._recordedChunks=[],this._resolve=null,this._reject=null,this._isRecording=!0,this._mediaRecorder.start(this._options.recordChunckSize),new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}dispose(){this._canvas=null,this._mediaRecorder=null,this._recordedChunks=[],this._fileName=null,this._resolve=null,this._reject=null}_handleDataAvailable(e){e.data.size>0&&this._recordedChunks.push(e.data)}_handleError(e){if(this.stopRecording(),!this._reject)throw new e.error;this._reject(e.error)}_handleStop(){this.stopRecording();const e=new Blob(this._recordedChunks);this._resolve&&this._resolve(e),window.URL.createObjectURL(e),this._fileName&&o.S0.Download(e,this._fileName)}}d._DefaultOptions={mimeType:"video/webm",fps:25,recordChunckSize:3e3};var u=r(55823),l=r(88337),p=r(93819),_=r(31488),g=r(31273),f=r(60743),m=r(95611);f.Z.prototype.removeReflectionProbe=function(e){if(!this.reflectionProbes)return-1;const t=this.reflectionProbes.indexOf(e);return-1!==t&&this.reflectionProbes.splice(t,1),t},f.Z.prototype.addReflectionProbe=function(e){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(e)};class v{constructor(e,t,r,i=!0,s=!1,n=!1){if(this.name=e,this._viewMatrix=g.uq.Identity(),this._target=g.Pq.Zero(),this._add=g.Pq.Zero(),this._invertYAxis=!1,this.position=g.Pq.Zero(),this.metadata=null,this._parentContainer=null,this._scene=r,r.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let t=0;t<6;++t)this._sceneUBOs.push(r.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${t}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=[]),this._scene.reflectionProbes.push(this);let a=m.Y.TEXTURETYPE_UNSIGNED_BYTE;if(s){const e=this._scene.getEngine().getCaps();e.textureHalfFloatRender?a=m.Y.TEXTURETYPE_HALF_FLOAT:e.textureFloatRender&&(a=m.Y.TEXTURETYPE_FLOAT)}this._renderTargetTexture=new _.$(e,t,r,i,!0,a,!0),this._renderTargetTexture.gammaSpace=!n,this._renderTargetTexture.invertZ=r.useRightHandedSystem;const o=r.getEngine().useReverseDepthBuffer;let c;this._renderTargetTexture.onBeforeRenderObservable.add((e=>{switch(this._sceneUBOs&&(r.setSceneUniformBuffer(this._sceneUBOs[e]),r.getSceneUniformBuffer().unbindEffect()),e){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,r.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,r.useRightHandedSystem?1:-1)}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const t=r.useRightHandedSystem?g.uq.LookAtRHToRef:g.uq.LookAtLHToRef,i=r.useRightHandedSystem?g.uq.PerspectiveFovRH:g.uq.PerspectiveFovLH;t(this.position,this._target,g.Pq.Up(),this._viewMatrix),r.activeCamera&&(this._projectionMatrix=i(Math.PI/2,1,o?r.activeCamera.maxZ:r.activeCamera.minZ,o?r.activeCamera.minZ:r.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),r.setTransformMatrix(this._viewMatrix,this._projectionMatrix),r.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=r.activeCamera.rigParent||null)),r._forcedViewPosition=this.position})),this._renderTargetTexture.onBeforeBindObservable.add((()=>{const t=r.getEngine();this._currentSceneUBO=r.getSceneUniformBuffer(),t._enableGPUDebugMarkers&&(t.restoreDefaultFramebuffer(),t._debugPushGroup?.(`reflection probe generation for ${e}`)),c=this._scene.imageProcessingConfiguration.applyByPostProcess,n&&(r.imageProcessingConfiguration.applyByPostProcess=!0)})),this._renderTargetTexture.onAfterUnbindObservable.add((()=>{const e=r.getEngine();r.imageProcessingConfiguration.applyByPostProcess=c,r._forcedViewPosition=null,this._sceneUBOs&&r.setSceneUniformBuffer(this._currentSceneUBO),r.updateTransformMatrix(!0),e._enableGPUDebugMarkers&&e._debugPopGroup?.()}))}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}set renderList(e){this._renderTargetTexture.renderList=e}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(-1!==e&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const e=this._parentContainer.reflectionProbes.indexOf(this);e>-1&&this._parentContainer.reflectionProbes.splice(e,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=p.p.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,r){let i=null;if(t.reflectionProbes)for(let r=0;r<t.reflectionProbes.length;r++){const s=t.reflectionProbes[r];if(s.name===e.name){i=s;break}}return i=p.p.Parse((()=>i||new v(e.name,e.renderTargetSize,t,e._generateMipMaps)),e,t,r),i.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&i.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(i.metadata=e.metadata),i}}(0,u.Cg)([(0,l.xG)()],v.prototype,"_attachedMesh",void 0),(0,u.Cg)([(0,l.P_)()],v.prototype,"position",void 0);var b=r(21580),T=r(73118),C=r(75876);const R="equirectangularPanoramaPixelShader";C.l.ShadersStore[R]||(C.l.ShadersStore[R]="#ifdef GL_ES\nprecision highp float;\n#endif\n#define M_PI 3.1415926535897932384626433832795\nvarying vec2 vUV;uniform samplerCube cubeMap;void main(void) {vec2 uv=vUV;float longitude=uv.x*2.*M_PI-M_PI+M_PI/2.;float latitude=(1.-uv.y)*M_PI;vec3 dir=vec3(\n- sin( longitude )*sin( latitude ),\ncos( latitude ),\n- cos( longitude )*sin( latitude )\n);normalize( dir );gl_FragColor=textureCube( cubeMap,dir );}");var x=r(76295),P=r(35647),S=r(70816);const y=({scene:e})=>{const[t,r]=(0,a.useState)(!1),[s,d]=(0,a.useState)({precision:1}),u=(0,a.useCallback)((async()=>{const r={...s};t||(r.width=void 0,r.height=void 0),e.activeCamera&&o.S0.CreateScreenshotUsingRenderTarget(e.getEngine(),e.activeCamera,r,void 0,void 0,4)}),[e,s,t]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h,{label:"Capture",icon:P.O5g9,onClick:u}),(0,i.jsx)(c.f,{label:"Precision",value:s.precision??1,onChange:e=>d({...s,precision:e??1}),min:.1,max:10,step:.1}),(0,i.jsx)(h.w,{label:"Use Custom Width/Height",value:t,onChange:e=>r(e)}),(0,i.jsxs)(x.S,{visible:t,children:[(0,i.jsx)(c.f,{label:"Width",value:s.width??512,onChange:e=>d({...s,width:e??512}),min:1,step:1}),(0,i.jsx)(c.f,{label:"Height",value:s.height??512,onChange:e=>d({...s,height:e??512}),min:1,step:1})]})]})},w=({scene:e})=>{const[t,r]=(0,a.useState)(!1),s=(0,a.useRef)(),c=(0,a.useCallback)((()=>{const t=e.frameGraph?S.Fd.FindMainCamera(e.frameGraph):e.activeCamera;t&&o.S0.CreateScreenshot(e.getEngine(),t,{precision:1})}),[e]),h=(0,a.useCallback)((async()=>{const t=e.activeCamera;!t&&e.frameGraph&&(e.activeCamera=S.Fd.FindMainCamera(e.frameGraph)),e.activeCamera&&await async function(e,t){const r=t.probe??new v("tempProbe",t.size,e),i=!!t.probe;i||(t.position?r.position=t.position.clone():e.activeCamera&&(r.position=e.activeCamera.position.clone()));const s=t.meshesFilter?e.meshes.filter(t.meshesFilter):e.meshes;r.renderList?.push(...s),r.refreshRate=_.$.REFRESHRATE_RENDER_ONCE,r.cubeTexture.render();const n=new b.y("tempProceduralTexture","equirectangularPanorama",{width:2*t.size,height:t.size},e);return n.setTexture("cubeMap",r.cubeTexture),await new Promise(((e,s)=>{n.onGeneratedObservable.addOnce((()=>{const a=n.readPixels();if(!a)return s(new Error("No Pixel Data found on procedural texture")),n.dispose(),void(i||r.dispose());a.then((s=>{n.dispose(),i||r.dispose(),t.filename?((0,T.DumpData)(2*t.size,t.size,s,void 0,"image/png",t.filename),e(null)):e(s)}))}))}))}(e,{size:1024,filename:"equirectangular_capture.png"}),e.activeCamera=t}),[e]),u=(0,a.useCallback)((async()=>{if(s.current&&s.current.isRecording)return s.current.stopRecording(),void r(!1);s.current||(s.current=new d(e.getEngine())),s.current.startRecording(),r(!0)}),[e]);return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h,{label:"Capture",icon:P.O5g9,onClick:c}),(0,i.jsx)(n.h,{label:"Capture Equirectangular",icon:P.O5g9,onClick:h}),(0,i.jsx)(n.h,{label:t?"Stop Recording":"Record Video",itemId:"Start/Stop Recording",icon:t?P.iOnG:P.cv3x,onClick:u})]})},M={friendlyName:"Capture Tools",consumes:[s.L],factory:e=>{const t=[];return t.push(e.addSectionContent({key:"Screenshot Capture",section:"Screenshot Capture",component:({context:e})=>(0,i.jsx)(w,{scene:e})})),t.push(e.addSectionContent({key:"RTT Capture",section:"RTT Capture",component:({context:e})=>(0,i.jsx)(y,{scene:e})})),{dispose:()=>{t.forEach((e=>e.dispose()))}}}},k={serviceDefinitions:[M]}}}]);
//# sourceMappingURL=4941.bundle.js.map