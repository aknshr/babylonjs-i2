{"version":3,"file":"7882.bundle.js","mappings":"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","sources":["webpack://@dev/inspector-v2/../loaders/src/glTF/2.0/Extensions/EXT_lights_image_based.ts?"],"sourcesContent":["import type { Nullable } from \"core/types\";\r\nimport { SphericalHarmonics, SphericalPolynomial } from \"core/Maths/sphericalPolynomial\";\r\nimport { Quaternion, Matrix } from \"core/Maths/math.vector\";\r\nimport type { BaseTexture } from \"core/Materials/Textures/baseTexture\";\r\nimport { RawCubeTexture } from \"core/Materials/Textures/rawCubeTexture\";\r\n\r\nimport type { IEXTLightsImageBased_LightReferenceImageBased, IEXTLightsImageBased_LightImageBased, IEXTLightsImageBased } from \"babylonjs-gltf2interface\";\r\nimport type { IScene } from \"../glTFLoaderInterfaces\";\r\nimport type { IGLTFLoaderExtension } from \"../glTFLoaderExtension\";\r\nimport { GLTFLoader, ArrayItem } from \"../glTFLoader\";\r\nimport { registerGLTFExtension, unregisterGLTFExtension } from \"../glTFLoaderExtensionRegistry\";\r\n\r\nconst NAME = \"EXT_lights_image_based\";\r\n\r\ndeclare module \"../../glTFFileLoader\" {\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    export interface GLTFLoaderExtensionOptions {\r\n        /**\r\n         * Defines options for the EXT_lights_image_based extension.\r\n         */\r\n        // NOTE: Don't use NAME here as it will break the UMD type declarations.\r\n        [\"EXT_lights_image_based\"]: {};\r\n    }\r\n}\r\n\r\ndeclare module \"babylonjs-gltf2interface\" {\r\n    /** @internal */\r\n    // eslint-disable-next-line @typescript-eslint/naming-convention\r\n    interface IEXTLightsImageBased_LightImageBased {\r\n        _babylonTexture?: BaseTexture;\r\n        _loaded?: Promise<void>;\r\n    }\r\n}\r\n\r\n/**\r\n * [Specification](https://github.com/KhronosGroup/glTF/blob/main/extensions/2.0/Vendor/EXT_lights_image_based/README.md)\r\n */\r\n// eslint-disable-next-line @typescript-eslint/naming-convention\r\nexport class EXT_lights_image_based implements IGLTFLoaderExtension {\r\n    /**\r\n     * The name of this extension.\r\n     */\r\n    public readonly name = NAME;\r\n\r\n    /**\r\n     * Defines whether this extension is enabled.\r\n     */\r\n    public enabled: boolean;\r\n\r\n    private _loader: GLTFLoader;\r\n    private _lights?: IEXTLightsImageBased_LightImageBased[];\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    constructor(loader: GLTFLoader) {\r\n        this._loader = loader;\r\n        this.enabled = this._loader.isExtensionUsed(NAME);\r\n    }\r\n\r\n    /** @internal */\r\n    public dispose() {\r\n        (this._loader as any) = null;\r\n        delete this._lights;\r\n    }\r\n\r\n    /** @internal */\r\n    public onLoading(): void {\r\n        const extensions = this._loader.gltf.extensions;\r\n        if (extensions && extensions[this.name]) {\r\n            const extension = extensions[this.name] as IEXTLightsImageBased;\r\n            this._lights = extension.lights;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @internal\r\n     */\r\n    // eslint-disable-next-line no-restricted-syntax\r\n    public loadSceneAsync(context: string, scene: IScene): Nullable<Promise<void>> {\r\n        return GLTFLoader.LoadExtensionAsync<IEXTLightsImageBased_LightReferenceImageBased>(context, scene, this.name, async (extensionContext, extension) => {\r\n            this._loader._allMaterialsDirtyRequired = true;\r\n\r\n            const promises = new Array<Promise<any>>();\r\n\r\n            promises.push(this._loader.loadSceneAsync(context, scene));\r\n\r\n            this._loader.logOpen(`${extensionContext}`);\r\n\r\n            const light = ArrayItem.Get(`${extensionContext}/light`, this._lights, extension.light);\r\n            promises.push(\r\n                // eslint-disable-next-line github/no-then\r\n                this._loadLightAsync(`/extensions/${this.name}/lights/${extension.light}`, light).then((texture) => {\r\n                    this._loader.babylonScene.environmentTexture = texture;\r\n                })\r\n            );\r\n\r\n            this._loader.logClose();\r\n\r\n            // eslint-disable-next-line github/no-then\r\n            return await Promise.all(promises).then(() => {});\r\n        });\r\n    }\r\n\r\n    // eslint-disable-next-line @typescript-eslint/promise-function-async, no-restricted-syntax\r\n    private _loadLightAsync(context: string, light: IEXTLightsImageBased_LightImageBased): Promise<BaseTexture> {\r\n        if (!light._loaded) {\r\n            const promises = new Array<Promise<any>>();\r\n\r\n            this._loader.logOpen(`${context}`);\r\n\r\n            const imageData = new Array<Array<ArrayBufferView>>(light.specularImages.length);\r\n            for (let mipmap = 0; mipmap < light.specularImages.length; mipmap++) {\r\n                const faces = light.specularImages[mipmap];\r\n                imageData[mipmap] = new Array<ArrayBufferView>(faces.length);\r\n                for (let face = 0; face < faces.length; face++) {\r\n                    const specularImageContext = `${context}/specularImages/${mipmap}/${face}`;\r\n                    this._loader.logOpen(`${specularImageContext}`);\r\n\r\n                    const index = faces[face];\r\n                    const image = ArrayItem.Get(specularImageContext, this._loader.gltf.images, index);\r\n                    promises.push(\r\n                        // eslint-disable-next-line github/no-then\r\n                        this._loader.loadImageAsync(`/images/${index}`, image).then((data) => {\r\n                            imageData[mipmap][face] = data;\r\n                        })\r\n                    );\r\n\r\n                    this._loader.logClose();\r\n                }\r\n            }\r\n\r\n            this._loader.logClose();\r\n\r\n            // eslint-disable-next-line github/no-then\r\n            light._loaded = Promise.all(promises).then(async () => {\r\n                const babylonTexture = new RawCubeTexture(this._loader.babylonScene, null, light.specularImageSize);\r\n                babylonTexture.name = light.name || \"environment\";\r\n                light._babylonTexture = babylonTexture;\r\n\r\n                if (light.intensity != undefined) {\r\n                    babylonTexture.level = light.intensity;\r\n                }\r\n\r\n                if (light.rotation) {\r\n                    let rotation = Quaternion.FromArray(light.rotation);\r\n\r\n                    // Invert the rotation so that positive rotation is counter-clockwise.\r\n                    if (!this._loader.babylonScene.useRightHandedSystem) {\r\n                        rotation = Quaternion.Inverse(rotation);\r\n                    }\r\n\r\n                    Matrix.FromQuaternionToRef(rotation, babylonTexture.getReflectionTextureMatrix());\r\n                }\r\n\r\n                if (!light.irradianceCoefficients) {\r\n                    throw new Error(`${context}: Irradiance coefficients are missing`);\r\n                }\r\n\r\n                const sphericalHarmonics = SphericalHarmonics.FromArray(light.irradianceCoefficients);\r\n                sphericalHarmonics.scaleInPlace(light.intensity);\r\n\r\n                sphericalHarmonics.convertIrradianceToLambertianRadiance();\r\n                const sphericalPolynomial = SphericalPolynomial.FromHarmonics(sphericalHarmonics);\r\n\r\n                // Compute the lod generation scale to fit exactly to the number of levels available.\r\n                const lodGenerationScale = (imageData.length - 1) / Math.log2(light.specularImageSize);\r\n                return await babylonTexture.updateRGBDAsync(imageData, sphericalPolynomial, lodGenerationScale);\r\n            });\r\n        }\r\n\r\n        // eslint-disable-next-line github/no-then\r\n        return light._loaded.then(() => {\r\n            return light._babylonTexture!;\r\n        });\r\n    }\r\n}\r\n\r\nunregisterGLTFExtension(NAME);\r\nregisterGLTFExtension(NAME, true, (loader) => new EXT_lights_image_based(loader));\r\n"],"names":["NAME","EXT_lights_image_based","constructor","loader","name","this","_loader","enabled","isExtensionUsed","dispose","_lights","onLoading","extensions","gltf","extension","lights","loadSceneAsync","context","scene","LoadExtensionAsync","async","extensionContext","_allMaterialsDirtyRequired","promises","Array","push","logOpen","light","Get","_loadLightAsync","then","texture","babylonScene","environmentTexture","logClose","Promise","all","_loaded","imageData","specularImages","length","mipmap","faces","face","specularImageContext","index","image","images","loadImageAsync","data","babylonTexture","specularImageSize","_babylonTexture","undefined","intensity","level","rotation","FromArray","useRightHandedSystem","Inverse","FromQuaternionToRef","getReflectionTextureMatrix","irradianceCoefficients","Error","sphericalHarmonics","scaleInPlace","convertIrradianceToLambertianRadiance","sphericalPolynomial","FromHarmonics","lodGenerationScale","Math","log2","updateRGBDAsync"],"ignoreList":[],"sourceRoot":""}