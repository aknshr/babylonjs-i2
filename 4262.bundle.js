"use strict";(self.webpackChunk_dev_inspector_v2=self.webpackChunk_dev_inspector_v2||[]).push([[4262],{34262:(e,t,o)=>{o.d(t,{BVHFileLoader:()=>C});var r=o(55179),n=o(51067),s=o(23138),i=o(21410),a=o(24614),l=o(1759),c=o(31273),f=o(21148);const p="Xposition",h="Yposition",m="Zposition",d="Xrotation",u="Yrotation",E="Zrotation";class w{constructor(e){this.loopMode=s.X5.ANIMATIONLOOPMODE_CYCLE,this.list=[],this.root=N(),this.numFrames=0,this.frameRate=0,this.skeleton=e}}function N(){return{name:"",type:"",offset:new c.Pq,channels:[],children:[],frames:[],parent:null}}function g(e,t,o){const r=function(e){const t=e.offset.x,o=e.offset.y,r=e.offset.z;return c.uq.Translation(t,o,r)}(e),n=new a.$(e.name,o.skeleton,t,r),i=function(e,t){if(0===e.frames.length)return[];const o=[],r=e.channels.some((e=>e===p||e===h||e===m)),n=e.channels.some((e=>e===d||e===u||e===E)),i=new s.X5(`${e.name}_pos`,"position",t.frameRate,s.X5.ANIMATIONTYPE_VECTOR3,t.loopMode),a=new s.X5(`${e.name}_rot`,"rotationQuaternion",t.frameRate,s.X5.ANIMATIONTYPE_QUATERNION,t.loopMode),l=[],c=[];for(let t=0;t<e.frames.length;t++){const o=e.frames[t];r&&o.position&&l.push({frame:o.frame,value:o.position.clone()}),n&&c.push({frame:o.frame,value:o.rotation.clone()})}return l.length>0&&(i.setKeys(l),o.push(i)),c.length>0&&(a.setKeys(c),o.push(a)),o}(e,o);for(const e of i)e.getKeys()&&e.getKeys().length>0&&n.animations.push(e);for(const t of e.children)g(t,n,o)}function H(e,t,o,r){if("ENDSITE"===o.type)return;const n={frame:0,position:new c.Pq,rotation:new c.PT};n.frame=t,n.position=new c.Pq,n.rotation=new c.PT,o.frames.push(n);let s=c.uq.Identity();for(let t=0;t<o.channels.length;++t){const i=o.channels[t],a=e[r.i++];if(!a)continue;const l=parseFloat(a.trim());if(i.endsWith("position"))switch(i){case p:n.position.x=l;break;case h:n.position.y=l;break;case m:n.position.z=l}else if(i.endsWith("rotation")){const e=f.S0.ToRadians(l);let t;switch(i){case d:t=c.uq.RotationX(e);break;case u:t=c.uq.RotationY(e);break;case E:t=c.uq.RotationZ(e)}s=t.multiply(s)}}c.PT.FromRotationMatrixToRef(s,n.rotation);for(const n of o.children)H(e,t,n,r)}function I(e,t,o,r){const n=N();n.parent=o,r.list.push(n);let s=t.trim().split(/\s+/);if("END"===s[0].toUpperCase()&&"SITE"===s[1].toUpperCase()?(n.type="ENDSITE",n.name="ENDSITE"):(n.name=s[1],n.type=s[0].toUpperCase()),"{"!=e.shift()?.trim())throw new Error("Expected opening { after type & name");const i=e.shift()?.trim().split(/\s+/);if(!i)throw new Error("Unexpected end of file: missing OFFSET");if(s=i,"OFFSET"!=s[0].toUpperCase())throw new Error("Expected OFFSET, but got: "+s[0]);if(4!=s.length)throw new Error("OFFSET: Invalid number of values");const a=new c.Pq(parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]));if(isNaN(a.x)||isNaN(a.y)||isNaN(a.z))throw new Error("OFFSET: Invalid values");if(n.offset=a,"ENDSITE"!=n.type){if(s=e.shift()?.trim().split(/\s+/),!s)throw new Error("Unexpected end of file: missing CHANNELS");if("CHANNELS"!=s[0].toUpperCase())throw new Error("Expected CHANNELS definition");const t=parseInt(s[1]);n.channels=s.splice(2,t),n.children=[]}for(;e.length>0;){const t=e.shift()?.trim();if("}"===t)return n;t&&n.children.push(I(e,t,n,r))}throw new Error("Unexpected end of file: missing closing brace")}function T(e,t,o,r){const n=e.split("\n"),{loopMode:s}=r;t._blockEntityCollection=!!o;const i=new l.E("","",t);i._parentContainer=o,t._blockEntityCollection=!1;const a=new w(i);a.loopMode=s;const c=n.shift();if(!c||"HIERARCHY"!==c.trim().toUpperCase())throw new Error("HIERARCHY expected");const f=n.shift();if(!f)throw new Error("Unexpected end of file after HIERARCHY");const p=I(n,f.trim(),null,a),h=n.shift();if(!h||"MOTION"!==h.trim().toUpperCase())throw new Error("MOTION expected");const m=n.shift();if(!m)throw new Error("Unexpected end of file before frame count");const d=m.trim().split(/[\s]+/);if(d.length<2)throw new Error("Invalid frame count line");const u=parseInt(d[1]);if(isNaN(u))throw new Error("Failed to read number of frames.");a.numFrames=u;const E=n.shift();if(!E)throw new Error("Unexpected end of file before frame time");const N=E.trim().split(/[\s]+/);if(N.length<3)throw new Error("Invalid frame time line");const T=parseFloat(N[2]);if(isNaN(T))throw new Error("Failed to read frame time.");if(T<=0)throw new Error("Failed to read frame time. Invalid value "+T);a.frameRate=1/T;for(let e=0;e<u;++e){const t=n.shift();t&&H(t.trim().split(/[\s]+/)||[],e,p,{i:0})}return a.root=p,g(a.root,null,a),a.skeleton.returnToRest(),a.skeleton}class C{constructor(e){this.name=i.T.name,this.extensions=i.T.extensions,this._loadingOptions={...C._DefaultLoadingOptions,...e??{}}}static get _DefaultLoadingOptions(){return{loopMode:s.X5.ANIMATIONLOOPMODE_CYCLE}}createPlugin(e){return new C(e[i.T.name])}canDirectLoad(e){return this.isBvhHeader(e)}isBvhHeader(e){return"HIERARCHY"==e.split("\n")[0]}isNotBvhHeader(e){return!this.isBvhHeader(e)}importMeshAsync(e,t,o){if("string"!=typeof o)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(o))return Promise.reject("BVH loader expects HIERARCHY header.");try{const e=T(o,t,null,this._loadingOptions);return Promise.resolve({meshes:[],particleSystems:[],skeletons:[e],animationGroups:[],transformNodes:[],geometries:[],lights:[],spriteManagers:[]})}catch(e){return Promise.reject(e)}}loadAsync(e,t){return"string"!=typeof t?Promise.reject("BVH loader expects string data."):this.isNotBvhHeader(t)?Promise.reject("BVH loader expects HIERARCHY header."):this.importMeshAsync(null,e,t).then((()=>{}))}loadAssetContainerAsync(e,t){if("string"!=typeof t)return Promise.reject("BVH loader expects string data.");if(this.isNotBvhHeader(t))return Promise.reject("BVH loader expects HIERARCHY header.");const o=new n.WZ(e);try{const r=T(t,e,o,this._loadingOptions);return o.skeletons.push(r),Promise.resolve(o)}catch(e){return Promise.reject(e)}}}(0,r.qS)(new C)}}]);
//# sourceMappingURL=4262.bundle.js.map